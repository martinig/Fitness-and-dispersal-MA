
 mytree <- readata_for_tree(file = "~/Documents/Files/Post-docs/UNSW 2022-2024/Aim 1/Fitness-and-dispersal-MA/data/species_tree_plotting.tre") #if you need to read the tree
 
 #basic plots that do work

plot(mytree, show.tip.label = T, cex = 0.8, no.margin = TRUE)

 ggtree(mytree, layout="circular") +                    
   geom_tiplab( ) 

ggtree(mytree, layout="circular", branch.length = "none")
   
   
      

#these tip labels are only to be used to relabel for the final plot, not for the data that is being shared

data_for_tree <- mutate(df, tip.label = species_cleaned)  # For the correspondence between tree and data
data_for_tree $tip.label = as.factor(data_for_tree$tip.label)  # Convert to factor
data_for_tree$tip.label <- gsub("_", " ", data_for_tree$tip.label)  # remove underscores from data
mytree$tip.label <- strip_ott_ids(mytree$tip.label, remove_underscores = TRUE)  # remove underscores from tree

summary(data_for_tree$tip.label)  # Need to remove duplicate species for building the tree

data_for_tree <- data_for_tree %>%
    group_by(tip.label) %>%
    summarise(natal = dispersal_type == "natal", breeding = dispersal_type ==
        "breeding", both = dispersal_type == "B", survival = fitness_higher_level == "survival", reproduction = fitness_higher_level == "reproduction", indirect = fitness_higher_level == "indirect fitness")  # Summarise, for each species, whether they tested natal effects, breeding effects, or both - and also for the fitness higher level stuff

 data_for_tree$natal = as.numeric(data_for_tree$natal)  # convert TRUE/FALSE to binary values
data_for_tree$breeding = as.numeric(data_for_tree$breeding)  # convert TRUE/FALSE to binary values
data_for_tree$both = as.numeric(data_for_tree$both)  #convert TRUE/FALSE to binary values


 data_for_tree$survival = as.numeric(data_for_tree$survival)  # convert TRUE/FALSE to binary values
data_for_tree$reproduction = as.numeric(data_for_tree$reproduction)  # convert TRUE/FALSE to binary values
data_for_tree$indirect = as.numeric(data_for_tree$indirect)  #convert TRUE/FALSE to binary values

 data_for_tree <- data_for_tree %>% 
 	group_by(tip.label) %>%
 	summarise(natal = sum(natal), breeding = sum(breeding), both = sum(both), survival=sum(survival), reproduction=sum(reproduction), indirect=sum(indirect))
 
 # In some cases, values were repeated, so need to replace '2' values by '1'
data_for_tree$natal[data_for_tree$natal > 1] <- "1"
data_for_tree$breeding[data_for_tree$breeding >1] <- "1"
data_for_tree$both[data_for_tree$both >1] <- "1"

 # In some cases, values were repeated, so need to replace '2' values by '1'
data_for_tree$survival[data_for_tree$survival > 1] <- "1"
data_for_tree$reproduction[data_for_tree$reproduction >1] <- "1"
data_for_tree$indirect[data_for_tree$indirect >1] <- "1"


data_for_tree$natal = as.factor(data_for_tree$natal)  # convert back to factor for the plot
data_for_tree$breeding = as.factor(data_for_tree$breeding)
data_for_tree$both = as.factor(data_for_tree$both)

data_for_tree$survival = as.factor(data_for_tree$survival)  # convert back to factor for the plot
data_for_tree$reproduction = as.factor(data_for_tree$reproduction)
data_for_tree$indirect = as.factor(data_for_tree$indirect)



data_for_tree <- mutate(data_for_tree, dispersal_pattern = ifelse(natal == "1" & breeding =="0" & both == "0", "natal", ifelse(natal == "0" & breeding == "1" & both == "0", "breeding", "both")))  # If both natal and breeding, indicate 'both', if only natal, indicate 'natal', otherwise indicate 'breeding'

data_for_tree <- mutate(data_for_tree, fitness_measure = ifelse(survival == "1" & reproduction =="0" & indirect == "0", "survival", ifelse(survival == "0" & reproduction == "1" & indirect == "0", "reproduction", ifelse(survival == "0" & reproduction == "0" & indirect == "1", "indirect", "multiple"))))  # If survival, reproduction, or inbreeding, indicate 'multiple', if only survival, indicate 'survival', otherwise indicate 'reproductive'


es_count <- Species_info %>%
	group_by(species_cleaned) %>%
	mutate(n_es=sum(n=n()), tip.label=species_cleaned) %>%
	ungroup()  # For the correspondence between tree and data
es_count <- distinct(es_count)

data_for_tree_plot <- left_join(es_count, data_for_tree, by = "tip.label")  # Join this information to the rest of the data we want to plot

data_for_tree_plot <- data_for_tree_plot %>% dplyr::select(tip.label, n_es, dispersal_pattern, fitness_measure)
data_for_tree_plot <- distinct(data_for_tree_plot)

p <- ggtree(mytree, layout = "circular", lwd = 0.75)  # Circular tree
p <- p %<+% data_for_tree_plot  # link plot to data
p

p2 <- p + geom_fruit(geom = geom_tile, mapping = aes(fill = dispersal_pattern), width = 1,
    offset = 0.085) + scale_fill_manual(values = c("#009E73", "#CC79A7", "black"))  # Create tiles to indicate which metric was used for this species
p2

p3 <- p2 + new_scale_fill() + geom_fruit(geom = geom_tile, mapping = aes(fill = fitness_measure),
    offset = 0.1, width = 1) + scale_fill_manual(values = c("#E69F00",
    "#F0E442", "#0072B2"))  # Create tiles to indicate which metric was used for this species
p3

data_for_tree_plot$n_es = as.numeric(data_for_tree_plot$n_es)  # Convert to numeric 

p4 <- p3 + new_scale_fill() + geom_fruit(geom = geom_bar, mapping = aes(x = n_es), stat = "identity", col = "gray97", orientation = "y", axis.params = list(axis = "x",
    text.angle = -90, hjust = 0, text.size = 3), grid.params = list(alpha = 0.35),
    offset = 0.085, pwidth = 0.55, alpha = 0.8)  # Display number of effect sizes

p4


#can add four main silhouttes - mammals, birds, fish, insects (four colours)
#############

library(ggimage)

setwd("~/Documents/Files/Post-docs/UNSW 2022-2024/Aim 1/Fitness-and-dispersal-MA/figures/silhouettes")
p5 <- p4 + geom_image(x=10, y=50, image=paste0("red squirrel.png"), size=.05)
p5

 ggsave("species_tree_circular_v0.pdf", width = 12, height = 10, scale = 10)