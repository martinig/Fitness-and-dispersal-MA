#code to prepare the data for analysis#last edited Dec 12, 2023 by A. R. Martinig#Delete previous information stored rm(list=ls(all=T))##set wd to the folder with all your csv's in itsetwd("~/Documents/Files/Post-docs/UNSW 2022-2024/Aim 1")options(scipen=999, dplyr.width = Inf, tibble.print_min = 50, repos='http://cran.rstudio.com/') #scipen forces outputs to not be in scientific notation #dplyr.width will show all columns for head() function and tibble.print_min sets how many rows are printed and repos sets the cran mirror#load librariespackages=c("tidyverse", "dplyr", "googlesheets4") #do not put in the showtext package as it messes EVERYTHING up# Install packages not yet installedinstalled_packages <- packages %in% rownames(installed.packages())if (any(installed_packages == FALSE)) {  install.packages(packages[!installed_packages])}# Packages loadinglapply(packages, library, character.only = TRUE)# Read the Google Sheet into a dataframedf <- read.csv("Aim 1 - Aim 1.csv", header=T) %>%	filter(!composite_variable=="Y", !obsID=="TBD") %>%	mutate_if(is.character, as.factor) %>%	select(-c(title, DOI, journal, year, region, country, composite_variable, effect_size_p_value, consider_excluding, needs_second_opinion, cross_checked, data_source, comments)) %>%	#for now I am going to filter out some of the more complicated comparisons	#filter(!group_1 %in% c("nonbreeder", "low", "dead")) %>%	#group_by(function_needed, study_design) %>%	#slice_head(n=20) %>%	#droplevels() %>%
	mutate(fitness_metric_clean = as.factor(
		case_when(
		
		#reproduction of some sort
		fitness_metric %in% c("probability of reproducing", "probability of conception",  "percent males bred", "reproduced")  ~ "reproductive", 
		
		#number of offspring produced over a lifetime - including breeding success (i.e., bred at least once); grouping clutch size (number of eggs laid) and brood size (number of eggs that hatch)/number emerged
    		fitness_metric %in% c("clutch size", "brood size", "number of juveniles at emergence", "breeding probability", "nest success (at least once hatchling alive at banding)", "attained breeding success (individual bred)", "attaining breeder position", "bred at least once", "breed at least once in lifetime", "total number of offspring across lifetime", "relative clutch size", "produced offspring", "produced chicks in season", "percent of clutch hatched", "number of offspring", "number of hatchlings", "n offspring", "number of offspring per year", "number of mature ova", "number of eggs", "lifetime reproductive success (total eggs)")  ~ "lifetime breeding success", 
	    		
		#how the offspring themselves survive (NOTE: LRS is the number of offspring that survive to a set point)
    		fitness_metric %in% c("offspring survival to yearling", "offspring survival to independence", "offspring survival to age 4", "survival of offspring to yearling", "offspring survived two years", "offspring survived summer", "offspring survival to 7 days", "offspring survival to 30 days", "offspring survival (father)", "offspring survival (mother)", "son longevity (father)", "son longevity (mother)", "proportion of offspring surviving to 15", "number of surviving offspring per year", "produced offspring that survived to weaning", "number of recruits per birth", "n of juveniles alive in late summer per individual") ~ "offspring survival", 
    	
		#Number of offspring produced over a lifetime that survive until weaning or fledging
    		fitness_metric %in% c("number of fledglings", "annual number of fledglings", "number of fledglings per breeding attempt", "weaning success", "reproductive success (at least one fledgling)", "lifetime n of pups reared to weaning", "n pups reared to weaning", "at least one fledgling",  "at least one young fledged", "total number of offspring fledged", "percent of clutch fledged", "number of weaned offspring", "nestlings fledged", "no young fledged", "nest success", "proportion of eggs producing fledglings", "number of fledglings among successful nests", "number of fledglings (first breeding attempt)", "n offspring successfully weaned", "lifetime reproductive success (total fledglings)")  ~ "lifetime reproductive success", 
    		
	#number of offspring that survive until recruitment  (when they are "added" to a population)
	#"number of yearlings at emigration", "number of offspring recruited", "n of yearling daughters", "number of recruits per nest", "number of recruits", "number of daughters reaching sexual maturity", "at least one pup recruited", "total number of recruits", "total recruits across lifetime", "number of offspring surviving to subadult", "number of offspring surviving to 30 days", "number of offspring surviving", 

    		
    		#how old an individual is when they first have offspring - including how old an individual is when they reach sexual maturity
    		    fitness_metric %in% c("age at first reproduction", "age at maturity")  ~ "age at first reproduction",  

    		#time between birth and death or a set point (defined by authors)
   			fitness_metric %in% c("survival winter", "survival to yearling", "survival to maturity", "survival spring", "survival autumn", "survival annual", "survival 1st to 2nd year", "lifespan", "age at death", "longevity", "survival to reproductive maturity (overwinter)", "survival to following year", "survival to following spring", "survival to age 3", "survival to 35 days old", "survival summer", "survival rate", "survival >1 year", "survival (shooting season)", "survival (monthly)", "monthly survival", "successfully settling", "recruitment probability", "recruitment") ~ "survival", 	
   			
   			#offspring that go on to reproduce themselves
    			fitness_metric %in% c("offspring successfully bred at least once", "offspring lifetime reproductive success", "son lifetime reproductive success (father)", "son lifetime reproductive success (mother)", "number of fledglings that survived to breed") ~ "offspring reproduction", 

    			fitness_metric %in% c("inclusive fitness (direct + indirect)")  ~ "inclusive fitness",  
    		
    		#survive to reproduce
    		fitness_metric %in% c("reproduced as adult", "reproduced as yearling", "survival to reproduction (successfully weaned at least one offspring)", "reproductive success (she survived and hatched at least one egg)")  ~ "reproductive success",  

  		TRUE ~ fitness_metric)))
  		
  		#"number of fledglings that survived to breed" # CHECK if this is for a record where they actually bred or just survive to sexual maturity? 	summary(df)	table(df$function_needed)	table(df$effect_size)	table(df$effect_size_details)	table(df$effect_size_type)table(df$effect_size_direction)	table(df$effect_size_df)
table(df$fitness_metric)
table(df$fitness_metric_clean)
				#export google sheet to CSV to make it easier to work with (it is a pain because it has different file formats for numeric columns, like "lists")write.csv(df, "~/Documents/Files/Post-docs/UNSW 2022-2024/Aim 1/Fitness-and-dispersal-MA/data/clean_data.csv")	