#code to creat a taxonomic tree figure
#last edtied Jan 9, 2024 by A. R. Martinig



packages=c("rotl", "ape", "ggplot2", "ggnewscale", "ggtree", "ggtreeExtra") 

# Install packages not yet installed
installed_packages <- packages %in% rownames(installed.packages())
if (any(installed_packages == FALSE)) {
  install.packages(packages[!installed_packages])
}

# Packages loading
lapply(packages, library, character.only = TRUE)

select<-dplyr::select


#read in data and edit as needed
Species_info <- df %>%
  select(c("reference", "paperID", "common_name", "species", "species_class", "dispersal_type", "fitness_higher_level")) %>%
    mutate(species = 
    	case_when(
    		species == "Thryomanes bewickii, Junco hyemalis, Pipilo maculatus, Melospiza melodia" ~ "Passeriformes", #went with one of the species that is not in the tree yet
    		species %in% c("Canis lupus", "Canis lupus arabs") ~ "Canis lupus & Canis lupus arabs", 
    		species %in% c("Lagopus lagopus", "Lagopus lagopus scoticus")  ~ "Lagopus lagopus & Lagopus lagopus scoticus", 
    			species %in% c("Panthera tigris", "Panthera tigris tigris")  ~ "Panthera tigris & Panthera tigris tigris", 
  		TRUE ~ species)) 

head(Species_info)
#str(Species_info)
length(unique(Species_info$species)) #139
unique(Species_info$species) #needs cleaning
table(Species_info$species)

#Species_info$species <- gsub("_"," ", Species_info$animal) #get rid of the underscores

# Make a table of how many words each name has:
table((lengths(gregexpr("\\W+", Species_info$species)) + 1)) #48 records with >2 words species names (subspecies etc.)
 
 # Count the number of words in the 'species' column
word_counts <- lengths(gregexpr("\\S+", Species_info$species))

# Identify records with more than two words
more_than_two_words <- Species_info[word_counts > 2, ]

# Display the result
print(more_than_two_words)
 
taxa <- tnrs_match_names(unique(Species_info$species)) #fails due to non-recognizable names

# Fix obviously incompatible names (subspecies, name variants):
Species_info <- Species_info %>%
  mutate(
  animal = 
  	case_when(
  		species == "Vulpes macrotis mutica" ~ "Vulpes macrotis",
  		species == "Macaca mulatta tcheliensis" ~ "Macaca mulatta",
  		species == "Calidris alpina schinzii" ~ "Calidris alpina",
  		species == "Passeriformes" ~ "Junco hyemalis", #went with one of the species that is not in the tree yet
  		species == "Canis lupus & Canis lupus arabs" ~ "Canis lupus", 
    	species == "Lagopus lagopus & Lagopus lagopus scoticus"  ~ "Lagopus lagopus", 
    	species == "Panthera tigris & Panthera tigris tigris"  ~ "Panthera tigris", 
  		TRUE ~ species))
  		

#NA -> drop rows with "NA" as species name
Species_info <- Species_info[Species_info$animal != "NA", ]

table(Species_info$animal, useNA = "always") #no NA
length(unique(Species_info$animal)) #139

taxa <- tnrs_match_names(unique(Species_info$animal)) #runs fine
names(taxa)
synonyms(taxa) ##list of all synonyms
taxa$unique_name # main TOL names
table(taxa$approximate_match) ##1 approximate match
taxa %>% filter(approximate_match==TRUE)
table(taxa$flags) # flags 21 names with problems (hidden, hybrid, incertae_sedis_inherited, infraspecific, infraspecific) - will need fixing

mytree <- tol_induced_subtree(ott_ids = taxa$ott_id, label_format= "name") 
#this will fail

is.binary(mytree) #if it returns FALSE that means you have several branches coming from the same node

mytree$tip.label

## Tree tip labels need some cleaning:
mytree$tip.label <- gsub("\\(.*", "", mytree$tip.label) #remove comments
mytree$tip.label <- gsub("_"," ", mytree$tip.label) #get rid of the underscores
mytree$tip.label <- trimws(mytree$tip.label) #getting rid of the trailing whitespace

mytree$tip.label

#this lets me check which species names don't match up
#you want to get 100% matching records between the two (your original labels and the labels in the tree)
sort(intersect(as.character(mytree$tip.label), unique(Species_info$species))) ## 124 names are matching -  got quite a few left to fix
sort(setdiff(unique(Species_info$species), as.character(mytree$tip.label))) ## names from species column not matching with tip label
sort(setdiff(as.character(mytree$tip.label), unique(Species_info$species))) ## names from tip.label not matching in animal column

#need to fix any of the substitutions AND labels that are matched, but incorrectly

## Reverse substitutions of species names in the tree tip labels:
mytree$tip.label[mytree$tip.label == "Calidris alpina"] <- "Calidris alpina schinzii"
mytree$tip.label[mytree$tip.label == "Canis lupus"] <- "Canis lupus & Canis lupus arabs" 
mytree$tip.label[mytree$tip.label == "Junco hyemalis"] <- "Passeriformes" 
mytree$tip.label[mytree$tip.label == "Vulpes macrotis"] <- "Vulpes macrotis mutica" 
mytree$tip.label[mytree$tip.label == "Macaca mulatta"] <- "Macaca mulatta tcheliensis" 
mytree$tip.label[mytree$tip.label == "Panthera tigris"] <- "Panthera tigris & Panthera tigris tigris" 
mytree$tip.label[mytree$tip.label == "Lagopus lagopus scoticus"] <- "Lagopus lagopus & Lagopus lagopus scoticus" #red grouse
mytree$tip.label[mytree$tip.label == "Lagopus lagopus"] <- "Lagopus lagopus & Lagopus lagopus scoticus" #red grouse

		
## Other substitutions of species names made in the tree tip labels:
mytree$tip.label[mytree$tip.label == "Urocitellus parryii plesius"] <- "Spermophilus parryii plesius" #Arctic ground squirrel
mytree$tip.label[mytree$tip.label == "Urocitellus columbianus"] <- "Spermophilus columbianus" #Columbian ground squirrel


mytree$tip.label[mytree$tip.label == "Urocitellus townsendii"] <- "Spermophilus townsendii" #Townsend's Ground Squirrel
mytree$tip.label[mytree$tip.label == "Mustela putorius furo"] <- "Mustela furo" #ferret
mytree$tip.label[mytree$tip.label == "Vulpes lagopus"] <- "Alopex lagopus" #arctic fox
mytree$tip.label[mytree$tip.label == "Myodes glareolus"] <- "Clethrionomys glareolus" #bank vole
mytree$tip.label[mytree$tip.label == "Myodes rufocanus"] <- "Clethrionomys rufocanus" #Grey red-backed vole
mytree$tip.label[mytree$tip.label == "Poecile palustris"] <- "Parus palustris" #marsh tit
mytree$tip.label[mytree$tip.label == "Setophaga petechia"] <- "Dendroica petechia" #yellow warbler


#check matching records again
sort(intersect(as.character(mytree$tip.label), unique(Species_info$species))) ## 139 names are matching - all fixed 

str(mytree) #276 tips
head(Species_info)
 head(mytree)

 plot(mytree, show.tip.label = T, cex = 0.8, no.margin = TRUE)

 write.tree(mytree, file = "~/Documents/Files/Post-docs/UNSW 2022-2024/Aim 1/Fitness-and-dispersal-MA/data/species_tree_plotting.tre") #save the tree 
 mytree <- read.tree(file = "~/Documents/Files/Post-docs/UNSW 2022-2024/Aim 1/Fitness-and-dispersal-MA/data/species_tree_plotting.tre") #if you need to read the tree
 
 